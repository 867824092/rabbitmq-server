#@ load("@ytt:data", "data")
#@ load("util.star", "to_build_args")
#@ load("helpers.star", "ci_image", "ci_image_tag", "skip_ci_condition")

#@ def prepare_jobs(erlang_version=None, build_erlang=False):
prepare:
  name: prepare
  runs-on: ubuntu-18.04
  if: #@ skip_ci_condition()
  outputs:
    branch_or_tag_name: ${{ steps.ref.outputs.branch_or_tag_name }}
  #@yaml/text-templated-strings
  steps:
    - name: CHECKOUT REPOSITORY
      uses: actions/checkout@v2
    #! https://github.com/marketplace/actions/setup-elixir
    - name: CONFIGURE OTP & ELIXIR
      uses: actions/setup-elixir@v1
      with:
        otp-version: 23.1
        #! https://github.com/elixir-lang/elixir/releases
        elixir-version: 1.10.4
    - name: CHECK RABBITMQ COMPONENTS
      id: ref
      run: |
        branch_or_tag_name=${GITHUB_REF#refs/*/}
        echo "::set-output name=branch_or_tag_name::$branch_or_tag_name"
    #@ if build_erlang:
    - name: CHECKOUT ERLANG/OTP MASTER
      uses: actions/checkout@v2
      with:
        repository: erlang/otp
        path: erlang-git-master
    - name: DETERMINE ERLANG SHA
      id: erlang_sha
      run: |
        cd erlang-git-master
        erlang_sha=$(git rev-parse HEAD)
        echo "::set-output name=erlang_sha::$erlang_sha"
    - name: CLEANUP ERLANG/OTP MASTER
      run: |
        rm -rf erlang-git-master
    #@ end
xref:
  name: xref
  #@ if build_erlang:
  needs: [prepare]
  #@ end
  runs-on: ubuntu-18.04
  if: #@ skip_ci_condition()
  #@yaml/text-templated-strings
  steps:
    - name: CHECKOUT REPOSITORY
      uses: actions/checkout@v2
    #@ for dep in [d for d in data.values.deps if not getattr(d, "skip_xref", False)]:
    - name: RUN XREF (@= dep.name @)
      run: |
        make -C deps/(@= dep.name @) xref \
          base_rmq_ref=master \
          current_rmq_ref=${{ steps.ref.outputs.branch_or_tag_name }}
    #@ end

#@ if/end erlang_version == data.values.erlang_versions[-1]:
dialyze:
  name: dialyze
  #@ if build_erlang:
  needs: [prepare]
  #@ end
  runs-on: ubuntu-18.04
  if: #@ skip_ci_condition()
  #@yaml/text-templated-strings
  steps:
    - name: CHECKOUT REPOSITORY
      uses: actions/checkout@v2
    #@ for dep in [d for d in data.values.deps if not getattr(d, "skip_dialyzer", False)]:
    - name: RUN DIALYZE (@= dep.name @)
      run: |
        make -C deps/(@= dep.name @) dialyze \
          base_rmq_ref=master \
          current_rmq_ref=${{ steps.ref.outputs.branch_or_tag_name }} \
          FULL=
    #@ end
#@ end